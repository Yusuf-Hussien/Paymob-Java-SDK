name: Release

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 1: Build & verify before publishing
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    name: Build & Verify
    runs-on: ubuntu-latest

    environment: release
    env:
      PAYMOB_SECRET_KEY: ${{ secrets.PAYMOB_SECRET_KEY }}
      PAYMOB_API_KEY: ${{ secrets.PAYMOB_API_KEY }}
      PAYMOB_PUBLIC_KEY: ${{ secrets.PAYMOB_PUBLIC_KEY }}
      PAYMOB_HMAC_SECRET: ${{ secrets.PAYMOB_HMAC_SECRET }}
      PAYMOB_INTEGRATION_ID: ${{ secrets.PAYMOB_INTEGRATION_ID }}
      PAYMOB_REGION: ${{ vars.PAYMOB_REGION }}

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build and run unit tests
        run: mvn clean package --no-transfer-progress

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 2: Publish to Maven Central + GitHub Release
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  publish:
    name: Publish to Maven Central
    runs-on: ubuntu-latest
    needs: build
    environment: release
    env:
      RELEASE_VERSION: ${{ vars.RELEASE_VERSION }}

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up JDK 17 with Maven Central credentials
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
          server-id: central
          server-username: MAVEN_USERNAME
          server-password: MAVEN_PASSWORD

      - name: Import GPG signing key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          printenv GPG_PRIVATE_KEY > /tmp/gpg_key.asc
          gpg --batch --import /tmp/gpg_key.asc
          rm -f /tmp/gpg_key.asc
          gpg --list-secret-keys --keyid-format LONG

      - name: Set release version in pom.xml
        run: mvn versions:set -DnewVersion=${{ env.RELEASE_VERSION }} --no-transfer-progress

      - name: Publish to Maven Central
        id: publish
        continue-on-error: true
        run: mvn --batch-mode deploy -P release -Dgpg.passphrase="${MAVEN_GPG_PASSPHRASE}" --no-transfer-progress
        env:
          MAVEN_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

      - name: Evaluate publish outcome
        id: check-publish
        run: |
          if [ "${{ steps.publish.outcome }}" == "success" ]; then
            echo "published=true" >> $GITHUB_OUTPUT
            echo "âœ… Successfully published v${{ env.RELEASE_VERSION }} to Maven Central"
          else
            echo "published=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Publish failed or version already exists â€” skipping GitHub release"
          fi

      # â”€â”€ GitHub Release â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create GitHub Release
        id: create-release
        if: steps.check-publish.outputs.published == 'true'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ env.RELEASE_VERSION }}
          release_name: Paymob Java SDK v${{ env.RELEASE_VERSION }}
          draft: false
          prerelease: false
          body: |
            ## Paymob Java SDK v${{ env.RELEASE_VERSION }}

            Published to [Maven Central](https://central.sonatype.com/artifact/io.github.yusuf-hussien/paymob-java-sdk).

            ### Maven
            ```xml
            <dependency>
                <groupId>io.github.yusuf-hussien</groupId>
                <artifactId>paymob-java-sdk</artifactId>
                <version>${{ env.RELEASE_VERSION }}</version>
            </dependency>
            ```

            ### Gradle
            ```gradle
            implementation 'io.github.yusuf-hussien:paymob-java-sdk:${{ env.RELEASE_VERSION }}'
            ```

      - name: Upload JAR to GitHub Release
        if: steps.check-publish.outputs.published == 'true'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create-release.outputs.upload_url }}
          asset_path: target/paymob-java-sdk-${{ env.RELEASE_VERSION }}.jar
          asset_name: paymob-java-sdk-${{ env.RELEASE_VERSION }}.jar
          asset_content_type: application/java-archive

      - name: Skip notice
        if: steps.check-publish.outputs.published == 'false'
        run: |
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "âš ï¸  Version ${{ env.RELEASE_VERSION }} was not published."
          echo "ğŸ“  To release a new version:"
          echo "     1. Update RELEASE_VERSION in GitHub Settings â†’ Environments â†’ release"
          echo "     2. Push to main or trigger this workflow manually"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
